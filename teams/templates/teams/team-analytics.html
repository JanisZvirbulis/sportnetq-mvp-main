{% extends 'main.html' %}
{% load static %}
{% load widget_tweaks %}
{% load custom_tags %}
{% load i18n %}
{% block content %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock extra_js %}
<div class="main-container">
    {% include 'sidebar.html'%}
        <main class="analytics-card-content">
            <div class="row">
                <h1 class="">{% trans 'Analytics'%}</h1>
            </div>
            <div class="row">
                {% if role == '2' or role == '4' %}
                <a class="cal-btn" href="{%url 'team-seasons' pk=teamObj.id%}">{% trans 'Seasons'%}</a>   
                {% endif %}
            </div>
            <div class="analytics-total-card">     
                <div class="analytics-seasons">
                    <form method="post" onchange="this.submit();" class="form-card form-size-analytics me-20">
                        {% csrf_token %}
                        {% for field in form %}
                            <p>
                                <label for="{{ field.auto_id }}">{% trans 'Season'%}</label>
                                {{ field|add_class:"form-input" }}
                    
                                {% if field.help_text %}
                                    <small>{{ field.help_text }}</small>
                                {% endif %}
                                {% for error in field.errors %}
                                    <span class="error">{{ error }}</span>
                                {% endfor %}
                            </p>
                        {% endfor %}
                    </form>
                    <div class="row">
                        <svg width='20' height='20' viewBox='0 0 20 20' class="me-20" xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='20' height='20' stroke='none' fill='#000000' opacity='0'/>


                            <g transform="matrix(0.34 0 0 0.34 10 10)" >
                            <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" translate(-27.51, -26.5)" d="M 25 3 C 20.888354 3 17.362351 5.4575008 15.826172 9 L 15 9 C 14.447738123791542 9.00005521790535 14.000055217905349 9.447738123791542 14 10 L 14 14 C 14.000055217905349 14.552261876208458 14.447738123791542 14.999944782094651 15 15 L 15 19 C 15 22.234022 16.593115 25.125609 19 26.949219 L 19 31.5 C 19 31.604167 18.97677 31.704804 18.716797 31.947266 C 18.456827 32.189727 17.980596 32.491147 17.365234 32.798828 C 16.134511 33.41419 14.367952 34.074238 12.5625 34.951172 C 10.757048 35.828106 8.8937221 36.930064 7.4453125 38.537109 C 5.9969029 40.144154 5 42.28931 5 45 L 5 46 L 39 46 L 39 49 C 38.99989090511505 49.378737794443936 39.21373429005477 49.72504415656176 39.55240494715735 49.89458623057188 C 39.89107560425993 50.064128304582006 40.29646237810189 50.02781503813903 40.599609 49.800781 L 44 47.25 L 47.400391 49.800781 C 47.70353762189811 50.02781503813903 48.10892439574007 50.064128304582006 48.44759505284265 49.89458623057188 C 48.78626570994523 49.72504415656176 49.00010909488495 49.378737794443936 49 49 L 49 40.513672 C 49.094076 40.412196 49.188147 40.309807 49.261719 40.185547 C 49.693594 39.456125 49.611429 38.715503 49.328125 38.046875 C 49.799208 37.505103 50.111466 36.838413 49.986328 36.080078 C 49.859945 35.314194 49.333937 34.771705 48.683594 34.414062 C 48.713844 33.687987 48.550049 32.936222 47.931641 32.435547 C 47.316389 31.93743 46.580229 31.899438 45.882812 32.052734 C 45.430299 31.464745 44.803899 31 44.009766 31 C 43.233745 31 42.598335 31.443172 42.134766 32.052734 C 41.437573 31.899731 40.700943 31.937627 40.085938 32.435547 C 39.467517 32.936232 39.30567 33.687973 39.335938 34.414062 C 38.903983 34.651418 38.538976 34.979024 38.296875 35.390625 C 36.55993 34.483223 34.806637 33.814218 33.439453 33.205078 C 32.581638 32.822884 31.880723 32.453939 31.470703 32.132812 C 31.060683 31.811687 31 31.651521 31 31.5 L 31 26.949219 C 33.406885 25.125609 35 22.234022 35 19 L 35 15 C 35.55226187620846 14.999944782094651 35.99994478209465 14.55226187620846 36 14 L 36 10 C 35.99994478209465 9.447738123791542 35.55226187620846 9.000055217905349 35 9 L 34.175781 9 C 32.640149 5.4556083 29.112499 3 25 3 z M 25 5 C 27.995629 5 30.554753 6.6071029 31.927734 9 L 18.072266 9 C 19.445063 6.6073016 22.003893 5 25 5 z M 16 11 L 16.373047 11 C 16.457338608262177 11.010787267674857 16.542661391737823 11.010787267674857 16.626953 11 L 34 11 L 34 12.986328 C 33.99479174612606 12.986287313343723 33.98958325387394 12.986287313343723 33.984375 12.986328 C 33.93593040463499 12.987377970550261 33.887626171553165 12.991947339576246 33.839844 13 L 16.154297 13 C 16.103295478594358 12.99146045470492 16.05170845031263 12.986889414110044 15.999999999999998 12.986328 L 16 11 z M 17 15 L 33 15 L 33 19 C 33 21.755914 31.567964 24.252869 29.445312 25.667969 L 29 25.964844 L 29 31.5 C 29 32.430479 29.572067 33.186783 30.236328 33.707031 C 30.405229 33.839314 30.58413 33.963402 30.771484 34.082031 C 30.514972 34.679781 30.045002 35.237916 29.369141 35.720703 C 28.298136 36.485752 26.739949 37 25 37 C 23.260051 37 21.701864 36.485752 20.630859 35.720703 C 19.94612 35.231574 19.472886 34.665252 19.21875 34.058594 C 19.532025 33.862797 19.821141 33.651655 20.080078 33.410156 C 20.585733 32.938556 21 32.270833 21 31.5 L 21 25.964844 L 20.554688 25.667969 C 18.432037 24.252869 17 21.755914 17 19 L 17 15 z M 45.605469 32.111328 C 45.602169 32.111328 45.630196 32.117188 45.628906 32.117188 C 45.580381 32.133329 45.52891 32.138028 45.478516 32.146484 L 45.605469 32.111328 z M 46.027344 32.25 C 46.058314 32.27538 46.145192 32.334921 46.117188 32.306641 L 46.099609 32.349609 C 46.079579 32.313379 46.049254 32.28523 46.027344 32.25 z M 44.009766 33 C 44.321901 33 44.370723 33.0627 44.457031 33.324219 C 44.505475349212794 33.47039347344623 44.587020883805174 33.60340645400737 44.695312 33.712891 L 44.697266 33.714844 C 44.697737 33.715325 44.700672 33.716297 44.701172 33.716797 C 44.76178124423589 33.77806284667525 44.83005519177231 33.831237706107146 44.904297 33.875 C 44.954607 33.91655 44.944317 33.9345 45.054688 33.990234 C 45.319141 34.123783 45.555469 34.111328 45.605469 34.111328 C 45.78879875873156 34.1110409790441 45.96852246533606 34.06036710695898 46.125 33.964844 C 46.269872 33.876874 46.529788 33.871661 46.673828 33.988281 C 46.843513 34.125661 46.858674 34.190294 46.751953 34.513672 C 46.71833555427142 34.615103673170836 46.701191156361645 34.72126754067879 46.701172 34.828125 C 46.701172 34.943647 46.763631 34.964339 46.804688 35.072266 C 46.82463280084399 35.54298710692044 47.1704082214962 35.93595060559292 47.634766 36.015625 C 47.78465 36.040895 47.98615 36.237514 48.013672 36.404297 C 48.043902 36.587459 47.925792 36.814575 47.78125 36.902344 C 47.482608981299485 37.083949056215225 47.30044552970552 37.40828840715812 47.300781 37.757812 L 47.300781 38.060547 C 47.30092425304031 38.27513577812394 47.37008532142352 38.48398806852921 47.498047 38.65625 C 47.527907 38.69647 47.582246 39.098322 47.541016 39.167969 C 47.450976 39.320043 47.23819 39.426744 47.070312 39.398438 C 46.689145138575356 39.33425661038411 46.305118416017706 39.495471614719044 46.083984 39.8125 C 46.038084 39.84848 46.046091 39.830343 45.994141 39.882812 C 45.8082744031664 40.069683626144034 45.70368953937011 40.32237192143237 45.703125 40.585938 C 45.703125 40.863005 45.70261 40.878235 45.486328 40.951172 C 45.44146912125712 40.966281230238025 45.397739525189415 40.98455617059486 45.355469 41.005859 C 45.348619 41.009318 45.354417 41.009426 45.351562 41.011719 C 45.352812 41.006359 45.372414 41 45.306641 41 C 45.245151 41 45.064112 40.93713 44.919922 40.791016 C 44.732098014678776 40.601086536669136 44.47610017030937 40.494186413103975 44.208984 40.494141 L 44.009766 40.494141 L 43.808594 40.494141 C 43.54147782969063 40.494186413103975 43.285479985321224 40.601086536669136 43.097656 40.791016 C 42.943358 40.947247 42.765817 40.993896 42.566406 40.941406 C 42.443074 40.876346 42.314453 40.740136 42.314453 40.585938 C 42.314453 40.395671 42.241833 40.132108 42.119141 39.955078 C 41.996447 39.778048 41.871996 39.695673 41.810547 39.654297 C 41.762419 39.621891 41.760607 39.621505 41.759766 39.621094 C 41.535257266996275 39.43016429621384 41.23796458051434 39.34797979121604 40.947266 39.396484 C 40.779388 39.424794 40.566604 39.318094 40.476562 39.166016 C 40.356245 38.962802 40.344206 38.879342 40.501953 38.679688 C 40.64107397013124 38.50329562573406 40.71675392746127 38.28519987038938 40.716797 38.060547 L 40.716797 37.757812 C 40.71713247029448 37.40828840715812 40.534969018700515 37.083949056215225 40.236328 36.902344 C 40.09095 36.814064 39.973653 36.587634 40.003906 36.404297 C 40.031426 36.237514 40.232928 36.040898 40.382812 36.015625 C 40.8493254142867 35.936461225139396 41.19651545191614 35.54118638212243 41.214844 35.068359 C 41.254834 34.96191 41.316406 34.941748 41.316406 34.828125 C 41.316386843638355 34.72126754067879 41.29924244572858 34.615103673170836 41.265625 34.513672 C 41.1589 34.190294 41.17406 34.125661 41.34375 33.988281 C 41.48779 33.871663 41.747706 33.876879 41.892578 33.964844 C 42.22129597718622 34.16401088624733 42.635068406632165 34.15717799483287 42.957031 33.947266 C 43.243662040585676 33.842254599253906 43.466638488189716 33.61208545805506 43.5625 33.322266 C 43.617019 33.156238 43.860404 33 44.009766 33 z M 39.355469 34.865234 C 39.374679 34.954704 39.339018 35.055278 39.367188 35.140625 L 39.328125 34.898438 L 39.355469 34.865234 z M 48.664062 34.865234 L 48.691406 34.896484 L 48.652344 35.140625 C 48.680514 35.055275 48.644844 34.954709 48.664062 34.865234 z M 17.439453 34.957031 C 17.868087 35.895215 18.581663 36.715939 19.46875 37.349609 C 20.931245 38.394311 22.873949 39 25 39 C 27.126051 39 29.068755 38.394311 30.53125 37.349609 C 31.407098 36.723966 32.112515 35.915472 32.542969 34.992188 C 32.57174 35.005083 32.596031 35.018343 32.625 35.03125 C 33.050672 35.220906 33.5399 35.426638 34 35.621094 L 34 44 L 16 44 L 16 35.603516 C 16.512251 35.384399 16.968855 35.171453 17.439453 34.957031 z M 14 36.498047 L 14 44 L 7.1796875 44 C 7.3859927 42.323422 7.9551119 40.956315 8.9296875 39.875 C 10.106278 38.569545 11.742952 37.573066 13.4375 36.75 C 13.626405 36.658246 13.810652 36.585625 14 36.498047 z M 36 36.498047 C 36.851401 36.885623 37.700728 37.302719 38.496094 37.787109 C 38.563214 37.88002 38.626609 37.976058 38.703125 38.0625 C 38.422158 38.775347 38.386367 39.561481 38.755859 40.185547 C 38.824825 40.302028 38.912932 40.39774 39 40.494141 L 39 44 L 36 44 L 36 36.498047 z M 41 42.173828 C 41.221218 42.457757 41.497647 42.687276 41.835938 42.824219 C 41.8545967322449 42.83195061746056 41.87348539486472 42.83911523659411 41.892578 42.845703 C 42.662513 43.105347 43.399475 42.881443 44.009766 42.494141 L 44.166016 42.494141 C 44.525092 42.71035 44.842206 43 45.306641 43 C 45.488899 43 45.865844 42.93928 46.171875 42.810547 C 46.515412 42.683534 46.786179 42.471196 47 42.210938 L 47 47 L 44.599609 45.199219 C 44.244201757044166 44.93297640195997 43.755798242955834 44.93297640195997 43.400391 45.199219 L 41 47 L 41 45.167969 C 41.017849048052845 45.059977562535394 41.017849048052845 44.949788437464605 41 44.841797 L 41 42.173828 z" stroke-linecap="round" />
                            </g>
                            </svg>
                        <h3>
                            {% trans 'Total Team Athletes'%}: {{team_members_data|length}}
                        </h3>
                    </div>

                    <div class="row">
                        <svg width='20' height='20' viewBox='0 0 20 20' class="me-20" xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='20' height='20' stroke='none' fill='#000000' opacity='0'/>


                            <g transform="matrix(0.13 0 0 0.13 10 10)" >
                            <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" translate(-64, -64)" d="M 34 1 C 32.3 1 31 2.3 31 4 L 31 11 L 4 11 C 2.3 11 1 12.3 1 14 C 1 15.7 2.3 17 4 17 L 114 17 C 117.9 17 121 20.1 121 24 L 121 114 C 121 117.9 117.9 121 114 121 L 14 121 C 10.1 121 7 117.9 7 114 L 7 44 C 7 40.1 10.1 37 14 37 L 104 37 C 105.7 37 107 35.7 107 34 C 107 32.3 105.7 31 104 31 L 14 31 C 6.8 31 1 36.8 1 44 L 1 114 C 1 121.2 6.8 127 14 127 L 114 127 C 121.2 127 127 121.2 127 114 L 127 24 C 127 16.8 121.2 11 114 11 L 97 11 L 97 4 C 97 2.3 95.7 1 94 1 C 92.3 1 91 2.3 91 4 L 91 11 L 37 11 L 37 4 C 37 2.3 35.7 1 34 1 z M 29 51 C 22.9 51 18 55.9 18 62 C 18 68.1 22.9 73 29 73 C 35.1 73 40 68.1 40 62 C 40 55.9 35.1 51 29 51 z M 64 51 C 57.9 51 53 55.9 53 62 C 53 68.1 57.9 73 64 73 C 70.1 73 75 68.1 75 62 C 75 55.9 70.1 51 64 51 z M 99 51 C 92.92486775186127 51 88 55.92486775186127 88 62 C 88 68.07513224813873 92.92486775186127 73 99 73 C 105.07513224813873 73 110 68.07513224813873 110 62 C 110 55.92486775186127 105.07513224813873 51 99 51 z M 29 57 C 31.8 57 34 59.2 34 62 C 34 64.8 31.8 67 29 67 C 26.2 67 24 64.8 24 62 C 24 59.2 26.2 57 29 57 z M 64 57 C 66.8 57 69 59.2 69 62 C 69 64.8 66.8 67 64 67 C 61.2 67 59 64.8 59 62 C 59 59.2 61.2 57 64 57 z M 29 86 C 22.92486775186127 86 18 90.92486775186127 18 97 C 18 103.07513224813873 22.92486775186127 108 29 108 C 35.07513224813873 108 40 103.07513224813873 40 97 C 40 90.92486775186127 35.07513224813873 86 29 86 z M 64 86 C 57.9 86 53 90.9 53 97 C 53 103.1 57.9 108 64 108 C 70.1 108 75 103.1 75 97 C 75 90.9 70.1 86 64 86 z M 99 86 C 92.9 86 88 90.9 88 97 C 88 103.1 92.9 108 99 108 C 105.1 108 110 103.1 110 97 C 110 90.9 105.1 86 99 86 z M 64 92 C 66.8 92 69 94.2 69 97 C 69 99.8 66.8 102 64 102 C 61.2 102 59 99.8 59 97 C 59 94.2 61.2 92 64 92 z M 99 92 C 101.8 92 104 94.2 104 97 C 104 99.8 101.8 102 99 102 C 96.2 102 94 99.8 94 97 C 94 94.2 96.2 92 99 92 z" stroke-linecap="round" />
                            </g>
                            </svg>
                        <h3>
                            {% trans 'Total Events'%}: {{team_events|length}}
                        </h3>
                    </div>
                    <div class="analytics-seasons-list">
                        <table class="analytics-table-all">
                            {% for e in event_data %}
                                <tr>
                                    <td>{% trans e.label %}</td>
                                    <td>{{e.count}}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>   
                <div class="analytics-total-chart">
                    <canvas id="attendanceChart" class="canvas-border" width="330" height="330"></canvas>
                </div>
            </div>
 

            <div class="row">

                <h2 class="">{% trans 'Total attendance for each member'%}</h2>
                <div class="analytics-content">
                    {% if team_members_data|length > 0 %}
                        {% for team_member in team_members_data %}
                            <div class="analytics-card">
                                <div class="analytics-member">
                                    <img src="{{ team_member.member_data.imageURL }}" class="analytics-member-card-image">
                                    <h3>
                                        <a class="" href="{% url 'team-member-analytics' pk=teamObj.id mpk=team_member.member_id %}">{{ team_member.member_data.name|slice:'20'|capfirst }}</a>
                                    </h3>
                                </div>
                                <div class="analytics-chart">
                                    <canvas id="pieChart-{{ team_member.member_data.id }}" width="150" height="150"></canvas>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                    <p>
                        {% trans 'There is no information to analyze about team members'%}
                    </p>

                    
                    {% endif %}
                </div>
            </div>
        </main>
</div>

{% block custom_scripts_team %}
<script>
      const translationsTeam = {
        attended: '{{ _("Attended")|escapejs }}',
        didNotAttend: '{{ _("Did not attend")|escapejs }}',
        ill: '{{ _("Ill")|escapejs }}',
        injury: '{{ _("Injury")|escapejs }}',
        notRequired: '{{ _("Not required")|escapejs }}',
        other: '{{ _("Other")|escapejs }}',
        topLabel: '{{_("Total attendance for all athletes")|escapejs }}'
    };
    const attendanceData = {{ attendance_data|safe }};
    const labels = attendanceData.map(d => {
        switch (d.label) {
            case 'Attended': return translationsTeam.attended;
            case 'Did not attend': return translationsTeam.didNotAttend;
            case 'ill': return translationsTeam.ill;
            case 'Injury': return translationsTeam.injury;
            case 'Not required': return translationsTeam.notRequired;
            case 'Other': return translationsTeam.other;
            default: return d.label;
        }
    });
    const counts = attendanceData.map(d => d.count);
    const total = counts.reduce((a, b) => a + b);
    const percentages = counts.map(count => ((count / total) * 100).toFixed(2));
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar', // Change the chart type here (e.g., bar, line, radar, etc.)
        data: {
            labels: labels,
            datasets: [{
                label: translationsTeam.topLabel,
                data: percentages,
                backgroundColor: [
                    'rgba(75, 192, 192, 0.6)',   // Attended
                    'rgba(255, 99, 132, 0.6)',   // Did not attend
                    'rgba(255, 206, 86, 0.6)',   // Ill
                    'rgba(153, 102, 255, 0.6)',  // Injury
                    'rgba(255, 159, 64, 0.6)',   // Not required
                    'rgba(54, 162, 235, 0.6)',   // Other
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(54, 162, 235, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        boxWidth: 0  // Set the legend color box width to 0 to remove it
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const currentValue = percentages[context.dataIndex];
                            return `${labels[context.dataIndex]}: ${currentValue}%`;
                        }
                    }
                }
            }
        }
    });
</script>

{% endblock custom_scripts_team%}
{% block custom_scripts_members %}

<script>

    const translations = {
        attended: '{{ _("Attended")|escapejs }}',
        didNotAttend: '{{ _("Did not attend")|escapejs }}',
        ill: '{{ _("Ill")|escapejs }}',
        injury: '{{ _("Injury")|escapejs }}',
        notRequired: '{{ _("Not required")|escapejs }}',
        other: '{{ _("Other")|escapejs }}',
        noData: '{{ _("No attendance data available")|escapejs }}'
    };

    {% for team_member in team_members_data %}
        (function() {
            const ctx = document.getElementById('pieChart-{{ team_member.member_data.id }}').getContext('2d');
            const totalAttendance = {% for attendance in team_member.attendance_data %}{{ attendance.count }}{% if not forloop.last %} + {% endif %}{% endfor %};
            
            if (totalAttendance === 0) {
                ctx.font = '8px Arial';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.fillText(translations.noData, ctx.canvas.width / 2, ctx.canvas.height / 2);
            } else {
                const data = {
                    labels: [
                        translations.attended,
                        translations.didNotAttend,
                        translations.ill,
                        translations.injury,
                        translations.notRequired,
                        translations.other
                        ],
                    datasets: [{
                        data: [
                            {% for attendance in team_member.attendance_data %}
                                {{ attendance.count }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        ],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',   // Attended
                            'rgba(255, 99, 132, 0.6)',   // Did not attend
                            'rgba(255, 206, 86, 0.6)',   // ill
                            'rgba(153, 102, 255, 0.6)',  // Injury
                            'rgba(255, 159, 64, 0.6)',   // Not required
                            'rgba(54, 162, 235, 0.6)',   // Other
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(54, 162, 235, 1)',
                        ],
                        borderWidth: 0
                    }]
                };
                const options = {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataset = context.dataset;
                                    const currentValue = dataset.data[context.dataIndex];
                                    const total = dataset.data.reduce((a, b) => a + b);
                                    const percentage = ((currentValue / total) * 100).toFixed(2);
                                    return `${data.labels[context.dataIndex]}: ${currentValue} (${percentage}%)`;
                                }
                            }
                        },
                        legend: {
                            display: false // Hide the legend
                        }
                    }
                };
                const pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: data,
                    options: options
                });
            }
        })();
    {% endfor %}
</script>





{% endblock custom_scripts_members%}
{% endblock content %}