{% extends 'main.html' %}
{% load static %}
{% load widget_tweaks %}
{% load custom_tags %}
{% load i18n %}
{% block content %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock extra_js %}
<div class="main-container">
    {% include 'sidebar.html'%}
        <main class="analytics-card-content">
            <div class="team-group">
                <h1 class="team-name">{% trans 'Analytics for Athlete'%}</h1>
            </div>
            <div class="row">
                <a href="{% url 'team-analytics' teamObj.id %}" class="cal-btn me-20">{% trans 'Go Back'%}</a>
                {% if role == '2' or role == '4' %}
                <a class="cal-btn" href="{%url 'team-seasons' pk=teamObj.id%}">{% trans 'Seasons'%}</a>   
                {% endif %}
            </div>

            <div class="analytics-total-card">     
                <div class="analytics-seasons">
                    <form method="post" onchange="this.submit();" class="form-card form-size-analytics me-20">
                        {% csrf_token %}
                        {% for field in form %}
                            <p>
                                <label for="{{ field.auto_id }}">{% trans 'Season'%}</label>
                                {{ field|add_class:"form-input" }}
                    
                                {% if field.help_text %}
                                    <small>{{ field.help_text }}</small>
                                {% endif %}
                                {% for error in field.errors %}
                                    <span class="error">{{ error }}</span>
                                {% endfor %}
                            </p>
                        {% endfor %}
                    </form>
                    <div class="row mb-10">
                        <div class="analytics-teammember"> 
                            <img src="{{ team_member.profileID.imageURL }}" class="analytics-singlemember-card-image me-10">
                            <h2>
                                {{team_member.profileID.name|capfirst}}
                            </h2>
                        </div>
                    </div>

                    <div class="analytics-member-total-events">
                        <svg id='Schedule_32' width='32' height='32' viewBox='0 0 32 32' class="me-30" xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='32' height='32' stroke='none' fill='#000000' opacity='0'/>


                            <g transform="matrix(1.08 0 0 1.08 16 16)" >
                            <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" translate(-15, -15)" d="M 10 3 C 5.59375 3 2 6.59375 2 11 C 2 13.949219 3.613281 16.519531 6 17.90625 L 6 27 L 28 27 L 28 7 L 23 7 L 23 6 L 21 6 L 21 7 L 16.90625 7 C 15.519531 4.613281 12.949219 3 10 3 Z M 10 5 C 13.324219 5 16 7.675781 16 11 C 16 14.324219 13.324219 17 10 17 C 6.675781 17 4 14.324219 4 11 C 4 7.675781 6.675781 5 10 5 Z M 9 7 L 9 11.5625 L 7.28125 13.28125 L 8.71875 14.71875 L 10.71875 12.71875 L 11 12.40625 L 11 7 Z M 17.71875 9 L 21 9 L 21 10 L 23 10 L 23 9 L 26 9 L 26 11 L 18 11 C 18 10.304688 17.886719 9.644531 17.71875 9 Z M 17.71875 13 L 26 13 L 26 25 L 8 25 L 8 18.71875 C 8.644531 18.886719 9.304688 19 10 19 C 13.710938 19 16.820313 16.4375 17.71875 13 Z M 18 17 L 18 19 L 20 19 L 20 17 Z M 22 17 L 22 19 L 24 19 L 24 17 Z M 10 21 L 10 23 L 12 23 L 12 21 Z M 14 21 L 14 23 L 16 23 L 16 21 Z M 18 21 L 18 23 L 20 23 L 20 21 Z M 22 21 L 22 23 L 24 23 L 24 21 Z" stroke-linecap="round" />
                            </g>
                            </svg>
                        <h3>
                            {% trans 'Total events for member'%}: {{attendance_records|length}}
                        </h3>
                    </div>
                    <div class="analytics-athlete-table-container">
                        <div class="analytics-athlete-table-container-inside">
                                {% for ad in attendance_data %}
                                <div class="analytics-pratice-card">
                                    <div class="analytics-pratice-left">
                                        
                                        <b> {{ ad.label }} :</b>
                                    </div>
                                    <div class="analytics-pratice-right">
                                        <b> {{ ad.count }}</b>
                                    </div>
                                    
                                </div>
                                {% endfor %}
                        </div>
                    </div>
                </div>   
                <div class="analytics-charts">
                    <div class="analytics-total-chart">
                        <canvas id="attendanceChart2" class="canvas-border" width="330" height="330"></canvas>
                    </div>
                    <div class="analytics-total-chart">
                        <canvas id="attendanceChart" class="canvas-border" width="330" height="330"></canvas>
                    </div>
                </div>
                
            </div>

            <h3>{% trans 'Physical assessment scores'%}</h3>

            <div class="analytics-grid">
                {% regroup physical_assessment_scores by physical_assessment as assessment_groups %}


                    {% for assessment_group in assessment_groups %}
                    <div class="analytics-score-card">
                        <div class="analytics-score-heading">
                            <a href='{% url "single-physical-assessment" pk=teamObj.id papk=assessment_group.grouper.id %}' class="have-acc">
                            <div class="analytics-score-heading-list">
                                <div class="score-heading-row">
                                <h3>{{ assessment_group.grouper.physical_assessment_title}}</h3>
                                </div>
                                <div class="score-heading-row">
                                <p>{% trans 'Type'%}: {{ assessment_group.grouper.get_assessment_type_display }}</p>
                                </div>
                                <div class="score-heading-row">
                                <p>{% trans 'Best Score'%}:
                                    {% if assessment_group.grouper.best_score_lower %} {% trans 'Lowest'%} {% else %} {% trans 'Highest'%} {% endif %}
                                </p>
                                </div>
                            </div>
                            </a>
                        </div>
                        <div class="analytics-score-list">
                            <table class="analytics-score-table" data-best-score-lower="{{ assessment_group.grouper.best_score_lower }}" data-score-type="{{assessment_group.grouper.assessment_type}}">
                                <thead>
                                    <tr>
                                        <th>{% trans 'Date'%}</th>
                                        <th>{% trans 'Result'%}</th>
                                        <!-- Add other columns as needed -->
                                    </tr>
                                </thead>
                                <tbody>
                                    {% regroup assessment_group.list by physical_assessment_record.physical_assessment_date as date_groups %}

                                    {% for date_group in date_groups %}
                                        <tr>
                                            <td>{{ date_group.grouper|date:"d.m.Y" }}</td>
                                            {% for score in date_group.list %}
                                                {% if score.physical_assessment.assessment_type == 'score' %}
                                                <td>{{ score.score }}</td>
                                                {% endif %}
                                                {% if score.physical_assessment.assessment_type == 'time' %}
                                                <td>{{ score.time|format_time_duration }}</td>
                                                {% endif %}
                                                {% if score.physical_assessment.assessment_type == 'distance' %}
                                                <td>{{ score.distance|format_distance }}</td>
                                                {% endif %}
                                                <!-- Add other columns as needed -->
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
            </div>
            {% if role == "2" or role == "4" %}
            <div class="notes-section">
                <h3>{% trans 'Notes about member from events'%}</h3>
                {% for event in attendance_records %}
                    {% if event.short_note %}
                        <a href="{% url 'team-event' pk=teamObj.id eid=event.event.id %}" class="event-link">
                            <div class="event-row">
                                <div class="event-header">
                                    <span class="event-title">
                                        {{ event.event.title }}
                                    </span>
                                    <span class="event-time">
                                        {{ event.event.start_time|date:"H:i, d.m.Y " }}
                                    </span>
                                </div>
                                <div class="event-note">
                                    {{ event.short_note }}
                                </div>
                            </div>
                        </a>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </main>
        
</div>
{% block custom_scripts_bar %}

<script>

    const translationsMember = {
        attended: '{{ _("Attended")|escapejs }}',
        didNotAttend: '{{ _("Did not attend")|escapejs }}',
        ill: '{{ _("Ill")|escapejs }}',
        injury: '{{ _("Injury")|escapejs }}',
        notRequired: '{{ _("Not required")|escapejs }}',
        other: '{{ _("Other")|escapejs }}',
        topLabel: '{{_("Attendance for Athlete")|escapejs }}'
    };

    const attendanceData = {{ member_attendance_data|safe }};
    const labels = attendanceData.map(d => {
        switch (d.label) {
            case 'Attended': return translationsMember.attended;
            case 'Did not attend': return translationsMember.didNotAttend;
            case 'ill': return translationsMember.ill;
            case 'Injury': return translationsMember.injury;
            case 'Not required': return translationsMember.notRequired;
            case 'Other': return translationsMember.other;
            default: return d.label;
        }
    });
    const counts = attendanceData.map(d => d.count);
    const total = counts.reduce((a, b) => a + b);
    const percentages = counts.map(count => ((count / total) * 100).toFixed(2));
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar', // Change the chart type here (e.g., bar, line, radar, etc.)
        data: {
            labels: labels,
            datasets: [{
                label: translationsMember.topLabel,
                data: percentages,
                backgroundColor: [
                    'rgba(75, 192, 192, 0.6)',   // Attended
                    'rgba(255, 99, 132, 0.6)',   // Did not attend
                    'rgba(255, 206, 86, 0.6)',   // Ill
                    'rgba(153, 102, 255, 0.6)',  // Injury
                    'rgba(255, 159, 64, 0.6)',   // Not required
                    'rgba(54, 162, 235, 0.6)',   // Other
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(54, 162, 235, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        boxWidth: 0  // Set the legend color box width to 0 to remove it
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const currentValue = counts[context.dataIndex];
                            const currentPercentage = percentages[context.dataIndex];
                            return `${labels[context.dataIndex]}: ${currentValue} (${currentPercentage}%)`;
                        }
                    }
                }
            }
        }
    });

    
</script>


{% endblock custom_scripts_bar %}

{% block custom_scripts_pie %}

<script>
    const attendanceData2 = {{ attendance_data|safe }};
    const labels2 = attendanceData2.map(d => d.label);
    const counts2 = attendanceData2.map(d => d.count);
    var totalFilledRecordsText = `{% trans "athlete's load" %}`;
    const ctx2 = document.getElementById('attendanceChart2').getContext('2d');
    const chart2 = new Chart(ctx2, {
        type: 'pie', // Changed chart type to pie
        data: {
            labels: labels2,
            datasets: [{
                data: counts2,
                backgroundColor: [
                    'rgba(255, 215, 0, 0.6)',   // Color for first slice
                    'rgba(0, 128, 0, 0.6)',     // Color for second slice
                    'rgba(23, 162, 184, 0.6)',  // Color for third slice
                    'rgba(105, 105, 105, 0.6)'  // Color for fourth slice
                ],
                borderColor: [
                    'rgba(255, 215, 0, 1)',
                    'rgba(0, 128, 0, 1)',
                    'rgba(23, 162, 184, 1)',
                    'rgba(105, 105, 105, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                // Adding the title configuration here
                title: {
                    display: true,
                    text: totalFilledRecordsText 
                },
                legend: {
                    display: true,
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const currentValue = counts2[context.dataIndex];
                            const total = counts2.reduce((a, b) => a + b);
                            const percentage = ((currentValue / total) * 100).toFixed(2);
                            return `${labels2[context.dataIndex]}: ${currentValue} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock custom_scripts_pie %}
{% endblock content %}

